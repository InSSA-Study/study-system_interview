# 12장 : 채팅시스템설계

태그: 2023년 2월 28일 오전 9:45

### 채팅앱도 다 같은 채팅앱이 아니다.

페이스북 메신저, 위챗, 왓츠앱  → 1:1 채팅에 집중

슬랙(Slack) → 그룹 채팅에 집중을 둔 업무용 앱

디스코드(Discord) → 게임채팅

### 면접관이 원하는 앱이 무엇인가 → 1:1채팅 앱인가, 그룹 채팅 앱인가

- 둘 다 지원
- 모바일 , 웹 모두 지원
- 트래픽 규모  DAU 5천만명
- 그룹 채팅 인원제한 100명
- 중요 기능
    - 1:1 채팅
    - 그룹 채팅
    - 사용자 접속상태 표시
    - 텍스트 메시지
- 메시지 길이 제한 100,000자 이하
- 종단간 암호화 추후 논의
- 채팅 이력 영구 보관

## 2단계 개략적 설계안 제시 및 동의 구하기

채팅 시스템

- 클라이언트로부터 메시지 수신
- 메시지 수신자 결정 및 전달
- 수신자가 접속 상태가 아닌 경우에는 접속할 때까지 해당 메시지 보관

클라이언트

- 네트워크 통신 프로토콜을 사용하여 서비스에 접속
    - 어떤 통신 프로토콜을 사용할 것인가

- 메시지 송신 클라이언트 → 채팅 서비스 → 수신 클라이언트
    - HTTP 프로토콜 사용?
        - keep-alive 헤더 사용 : 클라이언트와 서버 사이의 연결을 끊지 않고 계속 유지
            
             : TCP 접속 과정에서 발생하는 핸드셰이크 횟수를 줄일 수 있음
            

HTTP는 클라이언트가 연결을 만드는 프로토콜. 

서버가 연결을 만드는 것처럼 동작할 수 있도록

1. 폴링
2. 롱 폴링
3. 웹 소켓

이 제안되었다.

## 폴링

클라이언트가 서버에게 주기적으로 메시지 있는지 물어보는 방법

![Untitled](12%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8E%E1%85%A2%E1%84%90%E1%85%B5%E1%86%BC%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20d48f9a49b3bf4010b4929129cd19af7d/Untitled.png)

- client 있는지 계속 물어보는 거

## 롱폴링

![Untitled](12%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8E%E1%85%A2%E1%84%90%E1%85%B5%E1%86%BC%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20d48f9a49b3bf4010b4929129cd19af7d/Untitled%201.png)

- **시간제한 둬서, 그냥 폴링 → client A - client B**
    - **공유하는게 깨질 수 있음**

생각해보자 

메시지를 보내는 클라이언트와 수신하는 클라이언트가 같은 채팅 서버에 접속 안 할 수도 있음 (stateless, round robin 알고리즘)

클라이언트입장에서 연결된 상태인지 알 수 있는 방법이 없음

클라이언트도 타임아웃이 일어날 때마다 주기적으로 서버에 다시 접속

## 웹 소켓

서버가 클라이언트에게 비동기 메시지를 보낼 때 사용

HTTP 연결 → 웹 소켓 연결 

웹소켓 연결은 항구적으로 유지되어야 하므로 서버측에서 연결 관리를 효율적으로 해야 한다.

![Untitled](12%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8E%E1%85%A2%E1%84%90%E1%85%B5%E1%86%BC%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20d48f9a49b3bf4010b4929129cd19af7d/Untitled%202.png)

[채팅 시스템] ⇒ 클라이언트와 서버 사이의 주 통신 프로토콜로 웹소켓을 사용하지만, 다른 부분에서는 굳이 웹소켓을 사용할 필요가 없음. 대부분의 기능은 일반적으로 HTTP 상에 구현

### [1] 무상태 서비스

- 로그인, 회원가입, 사용자 프로파일 표시 등을 처리하는 전통적인 요청/응답 서비스

로드밸런서 뒤에 위치한 서비스는 모놀리틱 서비스일 수도 있고, 마이크로서비스일 수도 있다.

상당수가 시장에 완제품으로 나와 있어서 직접 구현하지 않아도 쉽게 사서 쓸 수 있다.

→ **`서비스 탐색 서비스 (Service Discovery)`**  : 클라이언트가 접속할 채팅 서버의 DNS 호스트명을 클라이언트에게 알려주는 역할

### [2] 상태유지 서비스

- 채팅 서비스

![Untitled](12%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8E%E1%85%A2%E1%84%90%E1%85%B5%E1%86%BC%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20d48f9a49b3bf4010b4929129cd19af7d/Untitled%203.png)

![Untitled](12%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8E%E1%85%A2%E1%84%90%E1%85%B5%E1%86%BC%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%20d48f9a49b3bf4010b4929129cd19af7d/Untitled%204.png)

### 제3자 서비스 연동